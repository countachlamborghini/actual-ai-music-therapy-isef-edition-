<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="AI Music Therapy">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="ai_music_therapy">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ai_music_therapy</title>
  <base href="/actual-ai-music-therapy-isef-edition-/">
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js" id="faceapi-script"></script>
  <link rel="icon" type="image/png" href="favicon.png"/>
  <link rel="manifest" href="manifest.json">
  <style>
    /* Force Flutter elements to occupy full page to avoid zero-sized glass pane */
    flutter-view, flt-glass-pane, #flutterweb-theme, [flutter-view] {
      position: fixed !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      display: block !important;
      z-index: 0 !important;
    }
  </style>
</head>
<body>
  <!-- Deployment build banner: visible if this exact HTML is loaded -->
  <div id="deployed-version" style="position:fixed;top:10px;left:10px;padding:6px 10px;background:#0b74de;color:white;border-radius:6px;font-weight:600;z-index:9999">Build: 202601021740</div>
  <video id="emotion-video" autoplay muted playsinline style="display: none;"></video>
  <script>console.log('DEPLOY BUILD: 202601021740');</script>
  <script>
    window.addEventListener('error', function (e) {
      console.error('Runtime error captured:', e.message || e);
      const banner = document.getElementById('deployed-version');
      if (banner) banner.innerText = 'Build: 202601021740 — ERROR: ' + (e.message || 'see console');
      const detail = document.getElementById('deploy-error-detail');
      if (detail) detail.textContent = 'Runtime error: ' + (e.message || e);
      document.body.style.backgroundColor = '#fff8f8';
    });
    window.addEventListener('unhandledrejection', function (e) {
      console.error('Unhandled rejection:', e.reason || e);
      const banner = document.getElementById('deployed-version');
      if (banner) banner.innerText = 'Build: 202601021740 — UNHANDLED REJECTION';
      const detail = document.getElementById('deploy-error-detail');
      if (detail) detail.textContent = 'Unhandled rejection: ' + (e.reason && (e.reason.message || e.reason) || e);
      document.body.style.backgroundColor = '#fff8f8';
    });
  </script>
  <script src="flutter.js" type="application/javascript"
          onload="(function(){console.log('flutter.js loaded');try{const b=document.getElementById('deployed-version');if(b)b.innerText='Build: 202601021740 — flutter.js loaded';}catch(e){} })()"
          onerror="(function(){console.error('flutter.js failed to load');try{const b=document.getElementById('deployed-version');if(b)b.innerText='Build: 202601021740 — flutter.js load FAILED';}catch(e){} })()"></script>
  <script>
    // Prefer initializing via _flutter.loader so the engine initializer is available for main.dart.js
    try {
      const status = (s) => { try{ const b=document.getElementById('deployed-version'); if(b) b.innerText = 'Build: 202601021740 — ' + s; const d=document.getElementById('deploy-error-detail'); if(d) d.textContent = s; } catch(e){} };
      if (window._flutter && window._flutter.loader) {
        console.log('Using _flutter.loader to load entrypoint (will create main.dart.js tag via loader).');
        status('starting loader');
        // Use loader API which will create the script tag and provide engine initializer
        window._flutter.loader.loadEntrypoint({ onEntrypointLoaded: function(engineInitializer) {
          console.log('Engine initializer delivered by loader:', !!engineInitializer);
          status('engine initializer delivered');
          try {
            if (engineInitializer && engineInitializer.initializeEngine) {
              engineInitializer.initializeEngine().then(function(instance) {
                console.log('Engine initialized (via loader):', instance && !!instance.runApp);
                console.log('Engine instance keys:', instance ? Object.keys(instance) : '<no-instance>', instance);
                status('engine initialized');

                // If runApp exists, call it and observe for thrown errors
                if (instance && instance.runApp) {
                  try {
                    instance.runApp();
                    console.log('runApp called successfully');
                    status('runApp called');
                  } catch(e) {
                    console.error('runApp threw:', e);
                    status('runApp threw error: ' + (e && e.message || e));
                  }
                } else {
                  console.warn('No runApp method on engine instance; will inject main.dart.js fallback.');
                  status('no runApp — injecting main.dart.js fallback');
                  try {
                    var fb = document.createElement('script');
                    fb.src = 'main.dart.js'; fb.type = 'application/javascript';
                    fb.onload = function(){ console.log('main.dart.js loaded (injected fallback)'); status('main.dart.js loaded (fallback)'); };
                    fb.onerror = function(e){ console.error('main.dart.js failed to load (injected fallback)', e); status('main.dart.js load FAILED (fallback)'); };
                    document.head.appendChild(fb);
                  } catch(e) { console.error('Failed to inject main.dart.js fallback:', e); }
                }

                // Safety timeout: if runApp hasn't been observed in 2s, log and ensure fallback
                setTimeout(function(){
                  const banner = document.getElementById('deployed-version');
                  if (banner && banner.innerText.indexOf('runApp called')===-1) {
                    console.warn('runApp not observed after timeout; ensuring fallback');
                    status('no runApp observed — ensuring fallback');
                    if (!document.querySelector('script[src="main.dart.js"]')) {
                      var s2 = document.createElement('script'); s2.src = 'main.dart.js'; s2.type = 'application/javascript';
                      s2.onload = function(){ console.log('main.dart.js loaded (timeout-insert)'); status('main.dart.js loaded (timeout)'); };
                      s2.onerror = function(e){ console.error('main.dart.js failed to load (timeout-insert)', e); status('main.dart.js load FAILED (timeout)'); };
                      document.head.appendChild(s2);
                    }
                  }
                }, 2000);

              }).catch(function(e) { console.error('Engine initialization failed:', e); status('engine init failed: ' + (e && e.message || e)); });
            } else {
              console.warn('Loader delivered no initializeEngine.');
              status('loader delivered no initializeEngine');
            }
          } catch(e){ console.error('Error while invoking engineInitializer:', e); status('invoke engineInitializer error: ' + (e && e.message || e)); }
        }});
      } else {
        console.warn('_flutter.loader not available; falling back to adding main.dart.js directly');
        status('_flutter.loader not available — app may not initialize; loading main.dart.js fallback');
        var s = document.createElement('script'); s.src = 'main.dart.js'; s.type = 'application/javascript';
        s.onload = function(){ console.log('main.dart.js loaded (fallback script)'); status('main.dart.js loaded (fallback)'); };
        s.onerror = function(){ console.error('main.dart.js failed to load (fallback)'); status('main.dart.js load FAILED (fallback)'); };
        document.head.appendChild(s);
      }
    } catch(e) {
      console.error('Exception in loader bootstrap script:', e);
      try{const d=document.getElementById('deploy-error-detail'); if(d) d.textContent = 'bootstrap exception: ' + (e && e.message || e);}catch(e){}
      // Fallback: append main.dart.js directly
      var s2 = document.createElement('script'); s2.src = 'main.dart.js'; s2.type = 'application/javascript';
      s2.onload = function(){ console.log('main.dart.js loaded (fallback-exception)'); };
      s2.onerror = function(){ console.error('main.dart.js failed to load (fallback-exception)'); };
      document.head.appendChild(s2);
    }
  </script>
  <script>
    // Post-load runtime checks for Flutter
    setTimeout(() => {
      try {
        console.log('flutterConfiguration present:', !!window.flutterConfiguration);
        console.log('flutterCanvasKit present:', !!window.flutterCanvasKit);
        const views = document.querySelectorAll('flutter-view, flt-glass-pane, #flutterweb-theme, [flutter-view]');
        console.log('flutter view-like elements count:', views.length, views);

        // Highlight each suspected Flutter element and report its size/style
        views.forEach((el, i) => {
          try {
            const r = el.getBoundingClientRect();
            console.log(`Flutter element[${i}] tag:${el.tagName} id:${el.id || ''} class:${el.className} rect: ${r.width}x${r.height} @ (${r.left},${r.top})`);
            const cs = getComputedStyle(el);
            console.log(`Flutter element[${i}] computed style: display=${cs.display} position=${cs.position} width=${cs.width} height=${cs.height} visibility=${cs.visibility}`);
            const highlight = document.createElement('div');
            highlight.style.position = 'fixed';
            highlight.style.left = `${r.left}px`;
            highlight.style.top = `${r.top}px`;
            highlight.style.width = `${Math.max(2, r.width)}px`;
            highlight.style.height = `${Math.max(2, r.height)}px`;
            highlight.style.border = '3px dashed rgba(0,200,100,0.9)';
            highlight.style.zIndex = '999999';
            highlight.style.pointerEvents = 'none';
            highlight.title = `Flutter element ${i}`;
            document.body.appendChild(highlight);

            const info = document.createElement('div');
            info.style.position = 'fixed';
            info.style.left = `${Math.max(2, r.left)}px`;
            info.style.top = `${Math.max(2, r.top - 22)}px`;
            info.style.background = 'rgba(0,200,100,0.9)';
            info.style.color = '#fff';
            info.style.padding = '2px 6px';
            info.style.fontSize = '12px';
            info.style.zIndex = '1000000';
            info.textContent = `${el.tagName} ${Math.round(r.width)}x${Math.round(r.height)}`;
            document.body.appendChild(info);
          } catch (e) {
            console.warn('Failed to highlight element', e);
          }
        });

        // Also look for canvas elements and report
        const canvases = document.querySelectorAll('canvas');
        canvases.forEach((c, i) => {
          const r = c.getBoundingClientRect();
          console.log(`Canvas[${i}] size: ${r.width}x${r.height} display:${getComputedStyle(c).display}`);
        });
      } catch (e) {
        console.error('Runtime diagnostic failed:', e);
      }
    }, 1200);
  </script>
  <div id="deploy-error-detail" style="position:fixed;bottom:10px;left:10px;right:10px;padding:10px;background:#fff1f1;border-left:4px solid #ff4d4f;color:#222;display:block;z-index:9998"></div>
</body>
</html>